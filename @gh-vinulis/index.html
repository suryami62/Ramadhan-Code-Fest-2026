<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Prose Editor</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:    #0f0f13;
    --surf:  #16161d;
    --surf2: #1e1e28;
    --surf3: #252532;
    --bdr:   #2a2a38;
    --bdr2:  #38384a;
    --acc:   #7c6af7;
    --acc2:  #a78bfa;
    --acc3:  #c4b5fd;
    --red:   #f87171;
    --txt:   #e2e0f0;
    --txt2:  #9592b0;
    --txt3:  #55536a;
    --mono:  'JetBrains Mono', monospace;
    --sans:  'Syne', sans-serif;
    --r:     8px;
    --lh:    24px;
    --ep:    16px; /* editor padding */
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--txt);
    font-family: var(--mono);
    font-size: 14px;
    overflow: hidden;
    overscroll-behavior: none;
  }

  .app {
    display: flex;
    flex-direction: column;
    height: 100dvh;
  }

  /* ── TOPBAR ── */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 12px;
    height: 48px;
    background: var(--surf);
    border-bottom: 1px solid var(--bdr);
    flex-shrink: 0;
    gap: 8px;
  }
  .logo {
    font-family: var(--sans);
    font-weight: 800;
    font-size: 15px;
    color: var(--acc3);
    letter-spacing: -.3px;
    user-select: none;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .logo span { color: var(--txt3); font-weight: 400; }
  .topbar-actions { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    padding: 0 10px;
    height: 32px;
    border-radius: var(--r);
    border: 1px solid var(--bdr2);
    background: var(--surf2);
    color: var(--txt2);
    font-family: var(--mono);
    font-size: 11px;
    cursor: pointer;
    transition: background .12s, color .12s, border-color .12s;
    white-space: nowrap;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
  }
  .btn:hover   { background: var(--surf3); color: var(--txt); border-color: var(--acc); }
  .btn:active  { background: var(--surf3); color: var(--txt); }
  .btn.accent  { background: var(--acc); border-color: var(--acc); color: #fff; }
  .btn.accent:hover, .btn.accent:active { background: var(--acc2); }
  .btn svg { width: 13px; height: 13px; flex-shrink: 0; }
  /* On small screens hide text, show icons only */
  .btn-lbl { display: inline; }
  @media (max-width: 440px) {
    .btn-lbl { display: none; }
    .btn { padding: 0 9px; }
  }

  /* ── MAIN ── */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
    min-height: 0;
  }

  /* ── LINE NUMBERS ── */
  .gutter {
    width: 42px;
    background: var(--surf);
    border-right: 1px solid var(--bdr);
    overflow: hidden;
    flex-shrink: 0;
    position: relative;
    user-select: none;
  }
  .gutter-inner {
    position: absolute;
    top: 0; left: 0; right: 0;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    padding-top: var(--ep);
    padding-right: 8px;
  }
  .ln {
    height: var(--lh);
    line-height: var(--lh);
    color: var(--txt3);
    font-size: 11px;
    flex-shrink: 0;
    transition: color .1s;
  }
  .ln.cur { color: var(--acc3); }

  /* ── EDITOR AREA ── */
  .editor-wrap {
    flex: 1;
    position: relative;
    overflow: hidden;
    min-width: 0;
  }

  /* The real (invisible) textarea captures all input */
  #ta {
    position: absolute;
    inset: 0;
    opacity: 0;
    resize: none;
    border: none;
    outline: none;
    background: transparent;
    color: transparent;
    caret-color: transparent;
    font-family: var(--mono);
    font-size: 14px;
    line-height: var(--lh);
    padding: var(--ep);
    white-space: pre-wrap;
    word-break: break-word;
    overflow-y: auto;
    overflow-x: hidden;
    z-index: 10;
    -webkit-overflow-scrolling: touch;
    -webkit-user-select: text;
    user-select: text;
    /* Prevent iOS auto-zoom on focus */
    font-size: max(16px, 14px);
  }

  /* Visual mirror — non-interactive, just display */
  #vis {
    position: absolute;
    inset: 0;
    padding: var(--ep);
    line-height: var(--lh);
    font-size: 14px;
    font-family: var(--mono);
    color: var(--txt);
    white-space: pre-wrap;
    word-break: break-word;
    overflow-y: auto;
    overflow-x: hidden;
    pointer-events: none;
    z-index: 1;
    letter-spacing: .15px;
  }

  /* Fake blinking cursor injected into #vis */
  .fc {
    display: inline-block;
    width: 2px;
    height: 1.12em;
    background: var(--acc3);
    vertical-align: text-bottom;
    border-radius: 1px;
    animation: blink 1.1s step-end infinite;
    position: relative;
    top: 1px;
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
  .fc.pause { animation: none; opacity: 1; }

  /* ── AUTOCOMPLETE POPUP ──
     Fixed-position, coordinates computed via ACE-style line/column math.
     Never uses a mirrored div (breaks on mobile with virtual keyboard).
  */
  #ac {
    position: fixed;
    display: none;
    flex-direction: column;
    background: var(--surf2);
    border: 1px solid var(--bdr2);
    border-radius: var(--r);
    box-shadow: 0 8px 32px rgba(0,0,0,.65), 0 0 0 1px rgba(124,106,247,.1);
    width: 260px;
    max-height: 210px;
    overflow: hidden;
    z-index: 9999;
    touch-action: pan-y;
  }
  #ac.open { display: flex; }

  .ac-hd {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 5px 10px 4px;
    font-size: 10px;
    color: var(--txt3);
    letter-spacing: .7px;
    text-transform: uppercase;
    border-bottom: 1px solid var(--bdr);
    flex-shrink: 0;
  }
  .ac-hd em { color: var(--acc3); font-style: italic; font-size: 11px; letter-spacing: 0; }

  #ac-list {
    overflow-y: auto;
    flex: 1;
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
  }
  #ac-list::-webkit-scrollbar { width: 3px; }
  #ac-list::-webkit-scrollbar-thumb { background: var(--bdr2); border-radius: 3px; }

  .ac-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    min-height: 36px; /* comfy tap target */
    cursor: pointer;
    font-size: 13px;
    transition: background .07s;
    -webkit-tap-highlight-color: transparent;
  }
  .ac-row:hover   { background: rgba(124,106,247,.15); }
  .ac-row.hi      { background: rgba(124,106,247,.2); border-left: 2px solid var(--acc); padding-left: 8px; }
  .ac-ico {
    width: 20px; height: 20px;
    background: rgba(124,106,247,.16);
    border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    font-size: 9px; color: var(--acc3);
    flex-shrink: 0; font-style: normal;
  }
  .ac-m { color: var(--acc3); font-weight: 500; }
  .ac-r { color: var(--txt2); }

  .ac-ft {
    padding: 4px 10px;
    border-top: 1px solid var(--bdr);
    font-size: 10px;
    color: var(--txt3);
    flex-shrink: 0;
  }
  .kb { display: inline; }
  .tp { display: none; color: var(--acc3); }
  @media (pointer: coarse) { .kb { display: none; } .tp { display: inline; } }
  kbd {
    background: var(--surf3); border: 1px solid var(--bdr2);
    border-radius: 3px; padding: 1px 4px;
    font-family: var(--mono); font-size: 9px; color: var(--txt2);
  }

  /* ── STATUS BAR ── */
  .sb {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 12px;
    height: 24px;
    background: var(--acc);
    flex-shrink: 0;
    font-size: 10px;
    color: rgba(255,255,255,.85);
  }
  .sb-l, .sb-r { display: flex; align-items: center; gap: 10px; }
  .sb-itm { display: flex; align-items: center; gap: 4px; white-space: nowrap; }
  .sb-xs { display: flex; }
  @media (max-width: 360px) { .sb-xs { display: none; } }

  /* ── DICT PANEL ── */
  .overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,.65);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    z-index: 20000;
    display: none;
    align-items: flex-end;
    justify-content: center;
  }
  .overlay.open { display: flex; }
  @media (min-width: 600px) { .overlay { align-items: center; } }

  .panel {
    background: var(--surf);
    border: 1px solid var(--bdr2);
    border-radius: 12px 12px 0 0;
    width: 100%;
    max-width: 560px;
    max-height: 85dvh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 -8px 48px rgba(0,0,0,.6);
    animation: su .22s cubic-bezier(.34,1.36,.64,1);
  }
  @media (min-width: 600px) {
    .panel { border-radius: 12px; max-height: 80dvh; animation: si .2s cubic-bezier(.34,1.36,.64,1); }
  }
  @keyframes su { from{transform:translateY(40px);opacity:0} to{transform:translateY(0);opacity:1} }
  @keyframes si { from{transform:scale(.93);opacity:0}         to{transform:scale(1);opacity:1}     }

  .drag-handle {
    width: 36px; height: 4px;
    background: var(--bdr2); border-radius: 2px;
    margin: 10px auto 0; flex-shrink: 0;
  }
  @media (min-width: 600px) { .drag-handle { display: none; } }

  .p-head {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 20px 12px;
    border-bottom: 1px solid var(--bdr); flex-shrink: 0;
  }
  .p-title { font-family: var(--sans); font-weight: 700; font-size: 15px; }
  .p-title em { color: var(--acc3); font-style: normal; }
  .p-close {
    width: 28px; height: 28px;
    background: var(--surf2); border: 1px solid var(--bdr);
    border-radius: 6px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    color: var(--txt2); font-size: 16px;
    transition: background .12s, color .12s;
    -webkit-tap-highlight-color: transparent;
  }
  .p-close:hover, .p-close:active { background: var(--red); color: #fff; border-color: var(--red); }

  .p-bar {
    display: flex; align-items: center; gap: 8px;
    padding: 10px 20px;
    border-bottom: 1px solid var(--bdr); flex-shrink: 0;
  }
  .p-search {
    flex: 1;
    background: var(--surf2); border: 1px solid var(--bdr2); border-radius: var(--r);
    padding: 8px 12px; color: var(--txt); font-family: var(--mono); font-size: 13px;
    outline: none; transition: border-color .12s; -webkit-appearance: none;
  }
  .p-search:focus { border-color: var(--acc); }
  .p-search::placeholder { color: var(--txt3); }
  .p-stat { font-size: 11px; color: var(--txt3); white-space: nowrap; }
  .p-stat strong { color: var(--acc3); }

  .word-grid {
    flex: 1; overflow-y: auto; padding: 12px 20px;
    display: flex; flex-wrap: wrap; gap: 8px; align-content: flex-start;
    -webkit-overflow-scrolling: touch;
  }
  .word-grid::-webkit-scrollbar { width: 4px; }
  .word-grid::-webkit-scrollbar-thumb { background: var(--bdr2); border-radius: 4px; }

  .wtag {
    display: inline-flex; align-items: center; gap: 5px;
    background: var(--surf2); border: 1px solid var(--bdr2);
    border-radius: 100px; padding: 5px 8px 5px 12px;
    font-size: 12px; color: var(--txt2); font-family: var(--mono);
    transition: border-color .12s; min-height: 32px;
  }
  .wtag:hover { border-color: var(--red); }
  .wdel {
    width: 18px; height: 18px; border-radius: 50%;
    background: transparent; border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    color: var(--txt3); font-size: 12px; transition: all .12s;
    -webkit-tap-highlight-color: transparent; padding: 0; line-height: 1;
  }
  .wtag:hover .wdel, .wdel:active { background: var(--red); color: #fff; }

  .empty { width: 100%; text-align: center; color: var(--txt3); font-size: 13px; padding: 32px 0; }

  .p-foot {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 20px; border-top: 1px solid var(--bdr); flex-shrink: 0; gap: 8px;
  }
  .btn-danger { background: rgba(248,113,113,.1); border-color: rgba(248,113,113,.3); color: var(--red); }
  .btn-danger:hover, .btn-danger:active { background: var(--red); color: #fff; border-color: var(--red); }

  /* ── TOAST ── */
  #toast {
    position: fixed; bottom: 36px; left: 50%;
    transform: translateX(-50%) translateY(10px);
    background: var(--surf3); border: 1px solid var(--bdr2);
    color: var(--txt); padding: 8px 16px; border-radius: 100px;
    font-size: 12px; pointer-events: none; opacity: 0;
    transition: opacity .2s, transform .2s; z-index: 99999;
    white-space: nowrap; box-shadow: 0 4px 16px rgba(0,0,0,.4);
  }
  #toast.on { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Scrollbars */
  #ta::-webkit-scrollbar, #vis::-webkit-scrollbar { width: 4px; }
  #ta::-webkit-scrollbar-thumb, #vis::-webkit-scrollbar-thumb { background: var(--bdr2); border-radius: 4px; }
</style>
</head>
<body>
<div class="app">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="logo">IMPHNEMN<span>ViNulis</span></div>
    <div class="topbar-actions">
      <button class="btn" onclick="openDict()" title="Kelola Kamus">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
        <span class="btn-lbl">Kamus <span id="badge" style="color:var(--acc3)">(0)</span></span>
      </button>
      <button class="btn" onclick="doCopy()" title="Salin">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
        <span class="btn-lbl">Salin</span>
      </button>
      <button class="btn accent" onclick="doExport()" title="Export .txt">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        <span class="btn-lbl">Export</span>
      </button>
    </div>
  </div>

  <!-- EDITOR -->
  <div class="main">
    <div class="gutter"><div class="gutter-inner" id="gutter"></div></div>
    <div class="editor-wrap" id="edwrap">
      <textarea id="ta" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
      <div id="vis" aria-hidden="true"></div>
    </div>
  </div>

  <!-- STATUS BAR -->
  <div class="sb">
    <div class="sb-l">
      <div class="sb-itm">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
        <span id="sb-w">0 kata</span>
      </div>
      <div class="sb-itm sb-xs">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="3"/></svg>
        <span id="sb-p">Ln 1</span>
      </div>
    </div>
    <div class="sb-r">
      <span id="sb-c">0 char</span>
      <span class="sb-xs" style="opacity:.6">UTF-8</span>
    </div>
  </div>

</div>

<!-- AUTOCOMPLETE POPUP -->
<div id="ac" role="listbox">
  <div class="ac-hd">
    <span>SARAN</span>
    <em id="ac-q"></em>
  </div>
  <div id="ac-list"></div>
  <div class="ac-ft">
    <span class="kb"><kbd>↑↓</kbd> nav &nbsp;<kbd>Tab</kbd> pilih &nbsp;<kbd>Esc</kbd> tutup</span>
    <span class="tp">ketuk untuk sisipkan</span>
  </div>
</div>

<!-- DICTIONARY PANEL -->
<div class="overlay" id="dict-ol" onclick="olTap(event)">
  <div class="panel" onclick="event.stopPropagation()">
    <div class="drag-handle"></div>
    <div class="p-head">
      <div class="p-title">Kelola <em>Kamus</em></div>
      <div class="p-close" onclick="closeDict()">×</div>
    </div>
    <div class="p-bar">
      <input class="p-search" id="p-search" placeholder="Cari kata…" oninput="renderDict()">
      <span class="p-stat">Total: <strong id="p-total">0</strong></span>
    </div>
    <div class="word-grid" id="wgrid"></div>
    <div class="p-foot">
      <button class="btn btn-danger" onclick="clearDict()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>
        <span class="btn-lbl">Hapus Semua</span>
      </button>
      <div style="display:flex;gap:6px">
        <button class="btn" onclick="exportDict()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/></svg>
          <span class="btn-lbl">Export</span>
        </button>
        <button class="btn accent" onclick="closeDict()">Selesai</button>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
'use strict';
// ──────────────────────────────────────────────
//  CONSTANTS
// ──────────────────────────────────────────────
const LH   = 24;   // line-height in px  (matches CSS --lh)
const EP   = 16;   // editor padding px  (matches CSS --ep)
const KEY  = 'prose_v3';

// ──────────────────────────────────────────────
//  STATE
// ──────────────────────────────────────────────
let dict = new Set();
let body = '';

try {
  const d = JSON.parse(localStorage.getItem(KEY) || '{}');
  body = d.content || '';
  dict = new Set(d.dictionary || []);
} catch(_) {}

function save() {
  localStorage.setItem(KEY, JSON.stringify({ content: body, dictionary: [...dict] }));
}

// ──────────────────────────────────────────────
//  ELEMENTS
// ──────────────────────────────────────────────
const ta     = document.getElementById('ta');
const vis    = document.getElementById('vis');
const popup  = document.getElementById('ac');
const acList = document.getElementById('ac-list');
const acQEl  = document.getElementById('ac-q');
const gutter = document.getElementById('gutter');

// ──────────────────────────────────────────────
//  AUTOCOMPLETE STATE
// ──────────────────────────────────────────────
let acOpen    = false;
let acItems   = [];
let acIdx     = 0;
let acQuery   = '';
let blockBlur = false; // true while pointer/touch is on popup

// ──────────────────────────────────────────────
//  BOOT
// ──────────────────────────────────────────────
ta.value = body;
renderVis();
renderGutter();
updateStatus();
updateBadge();
ta.focus();

// ──────────────────────────────────────────────
//  VISUAL MIRROR
// ──────────────────────────────────────────────
let ctimer = null;

function renderVis() {
  const txt = ta.value;
  const pos = ta.selectionStart;
  const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  vis.innerHTML = esc(txt.slice(0, pos)) +
    '<span class="fc" id="fc"></span>' +
    esc(txt.slice(pos));
  vis.scrollTop  = ta.scrollTop;
  vis.scrollLeft = ta.scrollLeft;
}

function pauseCursor() {
  const fc = document.getElementById('fc');
  if (!fc) return;
  fc.classList.add('pause');
  clearTimeout(ctimer);
  ctimer = setTimeout(() => fc && fc.classList.remove('pause'), 500);
}

// ──────────────────────────────────────────────
//  GUTTER (LINE NUMBERS)
// ──────────────────────────────────────────────
function renderGutter() {
  const lines   = ta.value.split('\n');
  const count   = lines.length;
  const curLine = ta.value.slice(0, ta.selectionStart).split('\n').length;
  let h = '';
  for (let i = 1; i <= count; i++) {
    h += `<div class="ln${i === curLine ? ' cur' : ''}">${i}</div>`;
  }
  gutter.innerHTML = h;
  gutter.style.transform = `translateY(-${ta.scrollTop}px)`;
}

// ──────────────────────────────────────────────
//  STATUS BAR
// ──────────────────────────────────────────────
function updateStatus() {
  const t = ta.value;
  document.getElementById('sb-w').textContent =
    (t.trim() ? t.trim().split(/\s+/).length : 0) + ' kata';
  document.getElementById('sb-c').textContent = t.length + ' char';
  const ls = t.slice(0, ta.selectionStart).split('\n');
  document.getElementById('sb-p').textContent =
    `Ln ${ls.length}, K ${ls[ls.length-1].length + 1}`;
}

function updateBadge() {
  document.getElementById('badge').textContent = `(${dict.size})`;
}

// ──────────────────────────────────────────────
//  WORD HELPERS
// ──────────────────────────────────────────────
function lastWord() {
  // Returns raw word WITH original case — for display & insert.
  // Use .toLowerCase() only when matching against dict.
  const m = ta.value.slice(0, ta.selectionStart).match(/(\S+)$/);
  return m ? m[1] : '';
}

function recordWord() {
  // Called right after a space/newline is typed.
  // Store word with ORIGINAL case — strip non-word chars but keep capitalization.
  const pos = ta.selectionStart;
  const m   = ta.value.slice(0, pos - 1).match(/(\S+)$/);
  if (!m) return;
  const w = m[1].replace(/[^a-zA-Z0-9'-]/g, '');
  if (w.length >= 2) {
    dict.add(w);
    updateBadge();
    save();
  }
}

// ──────────────────────────────────────────────
//  AUTOCOMPLETE — POSITIONING
//
//  ACE.js approach: compute cursor pixel position from
//  (lineIndex × lineHeight) + textarea.getBoundingClientRect()
//  No mirror div needed — works perfectly with virtual keyboards.
// ──────────────────────────────────────────────

// Cached monospace char width
let _cw = null;
function charWidth() {
  if (_cw) return _cw;
  const sp = document.createElement('span');
  sp.style.cssText = `
    font-family:${getComputedStyle(ta).fontFamily};
    font-size:14px;          
    position:absolute; visibility:hidden; white-space:pre;
    top:-9999px; left:-9999px;
  `;
  sp.textContent = 'M';
  document.body.appendChild(sp);
  _cw = sp.getBoundingClientRect().width;
  document.body.removeChild(sp);
  return _cw;
}

window.addEventListener('resize', () => { _cw = null; });

function cursorCoords() {
  const text  = ta.value;
  const pos   = ta.selectionStart;
  const lines = text.slice(0, pos).split('\n');
  const lineN = lines.length - 1;   // 0-based
  const colN  = lines[lineN].length; // chars on this line

  const cw     = charWidth();
  const taRect = ta.getBoundingClientRect();

  // Pixel coords of cursor, relative to viewport
  const x = taRect.left + EP + colN * cw - ta.scrollLeft;
  const y = taRect.top  + EP + lineN * LH - ta.scrollTop + LH; // place below current line

  return { x, y };
}

function placePopup() {
  const { x, y } = cursorCoords();
  const PW  = 260;
  const PH  = 210;
  const vw  = window.innerWidth;
  // Use visualViewport height so popup is above mobile keyboard
  const vh  = window.visualViewport ? window.visualViewport.height : window.innerHeight;
  const voy = window.visualViewport ? window.visualViewport.offsetTop : 0;

  let left = x;
  let top  = y + voy;

  // Clamp horizontal
  if (left + PW > vw - 4) left = vw - PW - 4;
  if (left < 4)            left = 4;

  // Flip above if not enough space below
  if (top + PH > vh + voy - 4) top = (taRect_top() + EP + (cursorLineIdx()) * LH - ta.scrollTop) + voy - PH - 4;
  if (top < 4) top = 4;

  popup.style.left = left + 'px';
  popup.style.top  = top  + 'px';
}

function taRect_top() {
  return ta.getBoundingClientRect().top;
}
function cursorLineIdx() {
  return ta.value.slice(0, ta.selectionStart).split('\n').length - 1;
}

// ──────────────────────────────────────────────
//  SHOW / HIDE / RENDER POPUP
// ──────────────────────────────────────────────
function showAC(q) {
  // q is raw (cased). Match case-insensitively against dict, but keep original dict words.
  const qLow = q.toLowerCase();
  const items = [...dict]
    .filter(w => w.toLowerCase().startsWith(qLow) && w.toLowerCase() !== qLow)
    .sort((a, b) => a.length - b.length)
    .slice(0, 10);

  if (!items.length) { hideAC(); return; }

  acItems = items;
  acQuery = q;           // raw typed string — used to know how many chars to replace
  acIdx   = 0;
  acQEl.textContent = '"' + q + '"';

  renderACRows();
  placePopup();
  popup.classList.add('open');
  acOpen = true;
}

function renderACRows() {
  acList.innerHTML = acItems.map((w, i) => {
    // Highlight the typed prefix (using query length, not content — preserves word case)
    const matchPart = `<span class="ac-m">${x(w.slice(0, acQuery.length))}</span>`;
    const restPart  = `<span class="ac-r">${x(w.slice(acQuery.length))}</span>`;
    const hi = i === acIdx ? ' hi' : '';
    return `<div class="ac-row${hi}" role="option" data-i="${i}">` +
           `<i class="ac-ico">ab</i>${matchPart}${restPart}</div>`;
  }).join('');

  const sel = acList.querySelector('.hi');
  if (sel) sel.scrollIntoView({ block: 'nearest' });
}

function hideAC() {
  popup.classList.remove('open');
  acOpen = acItems.length = 0;
  acIdx = 0; acQuery = '';
}

function apply(word) {
  const pos = ta.selectionStart;
  const q   = acQuery;
  const val = ta.value;

  ta.value              = val.slice(0, pos - q.length) + word + ' ' + val.slice(pos);
  ta.selectionStart     =
  ta.selectionEnd       = pos - q.length + word.length + 1;

  body = ta.value;
  save();
  renderVis();
  renderGutter();
  updateStatus();
  hideAC();
  ta.focus();
}

// ──────────────────────────────────────────────
//  POPUP INTERACTION
//  The core mobile fix:
//  - mousedown → e.preventDefault() stops blur on desktop
//  - touchstart → set blockBlur=true so blur handler skips hideAC
//  - touchend   → e.preventDefault() kills ghost click, then apply()
// ──────────────────────────────────────────────
acList.addEventListener('mousedown', e => {
  e.preventDefault();               // keep focus on textarea (desktop)
  const row = e.target.closest('.ac-row');
  if (row) apply(acItems[+row.dataset.i]);
});

acList.addEventListener('touchstart', () => {
  blockBlur = true;                 // prevent blur from closing popup
}, { passive: true });

acList.addEventListener('touchend', e => {
  e.preventDefault();               // kill ghost click that would re-trigger blur
  blockBlur = false;
  const row = e.target.closest('.ac-row');
  if (row && acItems[+row.dataset.i] !== undefined) {
    apply(acItems[+row.dataset.i]);
  }
});

// ──────────────────────────────────────────────
//  KEYBOARD NAVIGATION
// ──────────────────────────────────────────────
ta.addEventListener('keydown', e => {
  if (!acOpen) return;
  if (e.key === 'ArrowDown')  { e.preventDefault(); acIdx = (acIdx+1) % acItems.length; renderACRows(); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); acIdx = (acIdx-1+acItems.length) % acItems.length; renderACRows(); }
  else if (e.key === 'Tab' || e.key === 'Enter') {
    if (acItems[acIdx] !== undefined) { e.preventDefault(); apply(acItems[acIdx]); }
  }
  else if (e.key === 'Escape') { e.preventDefault(); hideAC(); }
});

// ──────────────────────────────────────────────
//  INPUT
// ──────────────────────────────────────────────
ta.addEventListener('input', () => {
  body = ta.value;
  pauseCursor();

  const pos      = ta.selectionStart;
  const lastChar = ta.value[pos - 1];
  const isDelim  = lastChar === ' ' || lastChar === '\n';

  if (isDelim) {
    recordWord();
    hideAC();
  } else {
    const q = lastWord();
    q.length >= 1 ? showAC(q) : hideAC();
  }

  renderVis();
  renderGutter();
  updateStatus();
  save();
});

// ──────────────────────────────────────────────
//  OTHER TEXTAREA EVENTS
// ──────────────────────────────────────────────
ta.addEventListener('keyup',   () => { renderVis(); renderGutter(); updateStatus(); });
ta.addEventListener('click',   () => { renderVis(); renderGutter(); updateStatus(); hideAC(); });
ta.addEventListener('focus',   () =>  renderVis());
ta.addEventListener('blur',    () => {
  // Delay so touchend on popup runs first and can set blockBlur
  setTimeout(() => {
    if (!blockBlur) hideAC();
    blockBlur = false;
  }, 80);
  renderVis();
});

ta.addEventListener('scroll', () => {
  vis.scrollTop  = ta.scrollTop;
  vis.scrollLeft = ta.scrollLeft;
  gutter.style.transform = `translateY(-${ta.scrollTop}px)`;
  if (acOpen) placePopup();
});

// Re-position popup when virtual keyboard resizes viewport
if (window.visualViewport) {
  window.visualViewport.addEventListener('resize', () => { if (acOpen) placePopup(); });
  window.visualViewport.addEventListener('scroll', () => { if (acOpen) placePopup(); });
}
window.addEventListener('resize', () => { _cw = null; if (acOpen) placePopup(); });

// ──────────────────────────────────────────────
//  COPY / EXPORT
// ──────────────────────────────────────────────
function doCopy() {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(ta.value).then(() => toast('Disalin ✓'));
  } else {
    ta.select();
    document.execCommand('copy');
    toast('Disalin ✓');
  }
}

function doExport() {
  dl(ta.value, 'tulisan.txt');
  toast('Diunduh ✓');
}

function dl(text, name) {
  const a = Object.assign(document.createElement('a'), {
    href:     URL.createObjectURL(new Blob([text], { type: 'text/plain;charset=utf-8' })),
    download: name
  });
  a.click();
  URL.revokeObjectURL(a.href);
}

// ──────────────────────────────────────────────
//  DICTIONARY PANEL
// ──────────────────────────────────────────────
function openDict() {
  renderDict();
  document.getElementById('dict-ol').classList.add('open');
  setTimeout(() => document.getElementById('p-search').focus(), 80);
}
function closeDict() { document.getElementById('dict-ol').classList.remove('open'); }
function olTap(e) { if (e.target === document.getElementById('dict-ol')) closeDict(); }

function renderDict() {
  const q    = document.getElementById('p-search').value.toLowerCase().trim();
  const all  = [...dict].sort();
  const list = q ? all.filter(w => w.includes(q)) : all;
  document.getElementById('p-total').textContent = dict.size;
  const g = document.getElementById('wgrid');
  if (!list.length) {
    g.innerHTML = `<div class="empty">${q ? 'Tidak ada kata cocok.' : 'Kamus kosong — mulai mengetik!'}</div>`;
    return;
  }
  g.innerHTML = list.map(w =>
    `<div class="wtag">${x(w)}<button class="wdel" data-w="${x(w)}" onclick="delWord('${x(w)}')" title="Hapus">×</button></div>`
  ).join('');
}

function delWord(w) {
  dict.delete(w);
  updateBadge(); save(); renderDict();
  toast(`"${w}" dihapus`);
}
function clearDict() {
  if (!confirm('Hapus semua kata dari kamus?')) return;
  dict.clear(); updateBadge(); save(); renderDict();
  toast('Kamus dikosongkan');
}
function exportDict() {
  dl([...dict].sort().join('\n'), 'kamus.txt');
  toast('Kamus diekspor ✓');
}

// ──────────────────────────────────────────────
//  TOAST
// ──────────────────────────────────────────────
let _tt;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('on');
  clearTimeout(_tt);
  _tt = setTimeout(() => el.classList.remove('on'), 2000);
}

// ──────────────────────────────────────────────
//  UTIL
// ──────────────────────────────────────────────
function x(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
